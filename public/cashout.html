<!-- public/cashout.html -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Cashout Calendar</title>
  <style>
    :root { --bg:#f3f4ff; --bg-soft:#eef2ff; --card:#ffffff; --card-soft:#ffffff; --line:#e5e7eb; --fg:#0f172a; --muted:#6b7280; --success:#16a34a; --accent:#4f46e5; --accent-alt:#0ea5e9; --danger:#b91c1c; --pill:#e5e7eb; }
    *{box-sizing:border-box}
    body{
      margin:0;
      min-height:100vh;
      background:radial-gradient(circle at top,#e5e7eb 0,#f9fafb 40%,#eef2ff 100%);
      color:var(--fg);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;
      -webkit-font-smoothing:antialiased;
      position:relative;
      overflow-x:hidden;
      z-index:1;
    }
    body::before{content:none;}
    header{display:flex;align-items:center;justify-content:space-between;gap:12px;padding:4px 24px 4px;background:rgba(15,23,42,0.96);border-bottom:1px solid #020617;backdrop-filter:blur(16px);position:sticky;top:0;z-index:10;color:#e5e7eb}
    .title{margin:0;font-size:1.1rem;font-weight:600;letter-spacing:.04em;text-transform:uppercase}
    .actions{display:flex;gap:8px;align-items:center}
    .token{
      border-radius:999px;
      background:#020617;
      border:1px solid #4b5563;
      color:#e5e7eb;
      padding:6px 10px;
      min-width:210px;
      font-size:.8rem;
    }
    .token::placeholder{color:#9ca3af}
    .btn{border-radius:999px;border:0;background:#1f2937;color:#e5e7eb;padding:6px 10px;font-size:.8rem;cursor:pointer;display:inline-flex;align-items:center;gap:4px}
    .btn:hover{filter:brightness(1.08)}
    .link{color:#e5e7eb;background:#020617;padding:6px 10px;border-radius:999px;text-decoration:none;border:1px solid #1e293b;font-size:.8rem;display:inline-flex;align-items:center;gap:4px}
    .link:hover{color:#f9fafb;border-color:#334155}
    .wrap{max-width:1100px;margin:12px auto 24px;padding:0 16px 32px}
    .calendar-wrapper{width:100%;overflow-x:auto;-webkit-overflow-scrolling:touch}
    .nav{display:flex;justify-content:space-between;align-items:center;gap:16px;margin:2px 0 8px}
    .nav-left,.nav-right{display:flex;align-items:center;gap:8px}
    .nav-header-logo{
      height:96px;
      width:200px;
      flex-shrink:0;
      background-image:url('Bloombar_Header.png');
      background-repeat:no-repeat;
      background-position:center;
      background-size:cover;
    }
    .month-label{font-size:1.1rem;font-weight:600;color:#0f172a}
    .grid{display:grid;grid-template-columns:repeat(8,1fr);border:1px solid var(--line);background:var(--card);border-radius:18px;overflow:hidden;box-shadow:0 18px 40px rgba(15,23,42,0.16);min-width:720px}
    .weekday{background:#e5e7eb;color:#374151;padding:10px;font-weight:600;text-align:center;border-right:1px solid #e5e7eb;text-transform:uppercase;letter-spacing:.08em;font-size:.7rem}
    .weekday:last-child{border-right:0}
    .cell{background:var(--card-soft);min-height:120px;padding:10px;display:flex;flex-direction:column;border-right:1px solid var(--line);border-top:1px solid var(--line);transition:background-color .12s ease,box-shadow .12s ease,transform .12s ease}
    .cell.empty{background:#f9fafb}
    .cell.other-month{background:#f3f4ff}
    .cell:not(.empty):hover{background:#e5e7ff;box-shadow:0 0 0 1px rgba(148,163,184,0.5) inset}
    .cell.stamped{position:relative;overflow:hidden}
    .cell.stamped::after{
      content:'';
      position:absolute;
      inset:4px;
      background:url('BLOOM_Bar_Icon.png') center center no-repeat;
      background-size:220px 220px;
      opacity:0.25;
      pointer-events:none;
    }
    .daynum{font-weight:600;font-size:.8rem;color:var(--muted);margin-bottom:2px}
    .amounts{margin-top:auto;display:flex;flex-direction:column;gap:4px;font-variant-numeric:tabular-nums}
    .meta{color:#111827;font-weight:500;font-size:.85rem}
    .sold{font-weight:600;color:var(--accent-alt);font-size:.85rem}
    .amt{font-weight:600;color:var(--success);font-size:.85rem}
    .subtle{color:var(--muted);font-size:.85rem}
    .counted-input{margin-top:6px;width:100%;font-size:.78rem;padding:4px 6px;border-radius:999px;border:1px solid #d1d5db;background:#f9fafb;color:#111827}
    .counted-input:focus{outline:none;border-color:#4f46e5;box-shadow:0 0 0 1px rgba(79,70,229,.5);background:#fff}
    .var-line{margin-top:3px;font-size:.8rem;font-variant-numeric:tabular-nums;}
    .var-zero{color:var(--success) !important;font-weight:600;}
    .var-over{color:#b91c1c !important;font-weight:600;}
    .var-under{color:var(--success) !important;font-weight:600;}
    .week-total{background:#f3f4ff;font-size:.8rem;padding:10px 10px 8px;display:flex;flex-direction:column;justify-content:flex-start;font-variant-numeric:tabular-nums;border-left:2px solid #4f46e5;font-weight:500}
    .week-total strong{font-weight:700;margin-bottom:6px;color:#111827;letter-spacing:.08em;text-transform:uppercase;font-size:.72rem}
    .week-total span{margin-bottom:2px;font-weight:500;color:#111827}

    .count-actions{margin-top:4px;display:flex;gap:4px}
    .count-actions .count-save,
    .count-actions .count-clear{
      border:0;
      border-radius:999px;
      padding:2px 6px;
      font-size:.7rem;
      cursor:pointer;
      background:#e5e7eb;
      color:#111827;
    }
    .count-actions .count-clear{background:#fee2e2;color:#b91c1c}
    .count-actions .count-save.saved{background:#bbf7d0;color:#14532d}

    /* Small screens (e.g., iPhone portrait) */
    @media (max-width: 768px){
      header{padding:4px 12px}
      .wrap{max-width:none;padding:0 8px 24px}
      .nav{gap:8px}
      .nav-header-logo{width:150px;height:72px}
      .month-label{font-size:1rem}
      .cell{min-height:100px;padding:8px}
      .weekday{padding:8px;font-size:.65rem}
      .week-total{font-size:.75rem}
    }
  </style>
</head>
<body>
<header>
  <div style="display:flex;align-items:center;gap:10px;min-width:0">
    <h1 class="title">Cashout Calendar</h1>
  </div>
  <div class="actions">
    <input id="tokenInput" class="token" type="password" placeholder="Dashboard token (DASH_TOKEN)"/>
    <button id="applyToken" class="btn">Apply Token</button>
    <a id="backToDash" class="link" href="/dashboard">← Back to Dashboard</a>
  </div>
</header>

<div class="wrap">
  <div class="nav">
    <div class="nav-left">
      <button id="prev" class="btn">← Previous</button>
      <button id="today" class="btn">Today</button>
      <button id="next" class="btn">Next →</button>
    </div>
    <div class="nav-header-logo" aria-label="Bloom Bar Header"></div>
    <div class="nav-right">
      <img src="BLOOM_Bar_Icon.png" alt="Bloom Bar" style="width: 32px;height:32px;border-radius:999px;object-fit:cover"/>
      <div class="month-label" id="monthLabel">Loading…</div>
    </div>
  </div>

  <div class="calendar-wrapper">
    <div class="grid" id="weekdayRow"></div>
    <div class="grid" id="calendarGrid"></div>
  </div>

  <p class="subtle">Blue shows <strong>total sold</strong> (cash + card minus change due); green shows <strong>cash collected</strong> (<code>cashAmount − amountDue</code>) per day.</p>
</div>

<script>
  // ---- token helpers
  function qp(name){return new URL(location.href).searchParams.get(name)}
  function getToken(){return qp('auth')||localStorage.getItem('DASH_TOKEN')||''}
  function setToken(t){if(t)localStorage.setItem('DASH_TOKEN',t)}
  const tokenInput=document.getElementById('tokenInput');
  const backToDash=document.getElementById('backToDash');
  (function initToken(){
    const t=getToken(); tokenInput.value=t;
    backToDash.href='/dashboard';
  })();
  backToDash.addEventListener('click',function(e){
    e.preventDefault();
    const t=tokenInput.value.trim()||getToken();
    const url=t?`/dashboard?auth=${encodeURIComponent(t)}`:'/dashboard';
    window.location.href=url;
  });
  document.getElementById('applyToken').onclick=()=>{
    const t=tokenInput.value.trim(); setToken(t);
    const u=new URL(location.href); if(t)u.searchParams.set('auth',t);else u.searchParams.delete('auth');
    location.href=u.toString();
  };

  const weekdayRow=document.getElementById('weekdayRow');
  const grid=document.getElementById('calendarGrid');
  const monthLabel=document.getElementById('monthLabel');
  const currencyFmt=new Intl.NumberFormat(undefined,{style:'currency',currency:'USD',minimumFractionDigits:0,maximumFractionDigits:0});
  const integerFmt=new Intl.NumberFormat(undefined,{maximumFractionDigits:0});
  const WEEKDAYS=['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
  let serverCounted={};

  function formatVariance(delta){
    const rounded=Math.round(delta||0);
    const sign=rounded>0?'+':rounded<0?'-':'';
    return `${sign}${currencyFmt.format(Math.abs(rounded))}`;
  }

  function varianceClass(delta){
    if(!isFinite(delta))return'';
    const rounded=Math.round(delta||0);
    if(rounded===0)return'var-zero';
    // delta = counted - cash (rounded to whole dollars)
    // surplus (counted > cash) -> positive -> green
    // deficit (counted < cash) -> negative -> red
    return rounded>0?'var-under':'var-over';
  }

  function renderWeekdayHeader(){
    weekdayRow.innerHTML='';
    WEEKDAYS.forEach(w=>{
      const el=document.createElement('div'); el.className='weekday'; el.textContent=w; weekdayRow.appendChild(el);
    });
    const weekEl=document.createElement('div');
    weekEl.className='weekday';
    weekEl.textContent='Week';
    weekdayRow.appendChild(weekEl);
  }

  function firstOfMonth(y,m1){return new Date(y,m1-1,1)}
  function daysInMonth(y,m1){return new Date(y,m1,0).getDate()}
  function fmtMonth(y,m1){return new Date(y,m1-1,1).toLocaleString(undefined,{month:'long',year:'numeric'})}

  async function fetchMonthData(year,month){
    const headers={}; const t=getToken(); if(t) headers['x-auth-token']=t;
    // main month
    const r=await fetch(`/cashout/data?year=${year}&month=${month}`,{headers});
    if(!r.ok) throw new Error(`HTTP ${r.status}`);
    const {data,counted}=await r.json();
    const map=Object.create(null);
    const addIntoMap=(rows)=>{
      for(const it of rows){
        const k=(typeof it.day==='string'?it.day:new Date(it.day).toISOString()).slice(0,10);
        const existing=map[k]||{cashTotal:0,soldTotal:0,clientCount:0,serviceCount:0};
        map[k]={
          cashTotal:existing.cashTotal+Number(it.cashTotal||0),
          soldTotal:existing.soldTotal+Number(it.soldTotal||0),
          clientCount:existing.clientCount+Number(it.clientCount||0),
          serviceCount:existing.serviceCount+Number(it.serviceCount||0)
        };
      }
    };
    addIntoMap(data||[]);

    // start with counted values for this main month
    serverCounted=counted||{};

    // also pull the previous month so the last week of it can show
    const prevMonth=month===1?12:month-1;
    const prevYear=month===1?(year-1):year;
    try{
      const rPrev=await fetch(`/cashout/data?year=${prevYear}&month=${prevMonth}`,{headers});
      if(rPrev.ok){
        const {data:prevData,counted:prevCounted}=await rPrev.json();
        addIntoMap(prevData||[]);
        // merge previous month's counted as well so its days render when in view
        const prevMap=prevCounted||{};
        for(const k in prevMap){
          if(Object.prototype.hasOwnProperty.call(prevMap,k) && serverCounted[k]==null){
            serverCounted[k]=prevMap[k];
          }
        }
      }
    }catch(e){
      console.warn('cashout/data previous month failed',e);
    }

    return map;
  }

  async function renderCalendar(y,m1){
    monthLabel.textContent=fmtMonth(y,m1);
    grid.innerHTML='';
    const first=firstOfMonth(y,m1), startDow=first.getDay(), dim=daysInMonth(y,m1);

    // always draw the frame; fetch totals but don't crash UI if it fails
    let totals={};
    try { totals=await fetchMonthData(y,m1) } catch(e){ console.warn('cashout/data failed', e) }

    // tracking for weeks (sales, clients, cash, counted cash)
    let weekSalesTotal=0;
    let weekClientTotal=0;
    let weekCashTotal=0;
    let weekCountedTotal=0;
    let weekHasAnyCounted=false;
    let weekHasAnySales=false;
    let weekHasAnyCash=false;
    let dayIndexInWeek=0; // 0=Sun,6=Sat, always per-row

    const appendWeekTotalCell=()=>{
      const soldText=weekHasAnySales?currencyFmt.format(weekSalesTotal):'';
      // counted: show red 0 when there is no input
      const countedText=weekHasAnyCounted?currencyFmt.format(weekCountedTotal):'0';
      const reportedCashText=weekHasAnyCash?currencyFmt.format(weekCashTotal):'';
      // weekly variance uses same direction as daily: counted - cash
      const delta=weekHasAnyCounted&&weekHasAnyCash?(weekCountedTotal-weekCashTotal):null;
      const vClass=delta!=null?varianceClass(delta):'';
      const vText=delta!=null?formatVariance(delta):'';
      const weekCell=document.createElement('div');
      weekCell.className='cell week-total';
      weekCell.innerHTML=`<strong>Week</strong>
        <span>Sales: ${soldText||'-'}</span>
        <span>Clients: ${weekClientTotal>0?integerFmt.format(weekClientTotal):'-'}</span>
        <span>Cash Reported: ${reportedCashText||'-'}</span>
        <span>Counted: <span class="${weekHasAnyCounted?'':'var-over'}">${countedText}</span></span>
        <span class="var-line">Cash Var: <span class="${vClass}">${vText||''}</span></span>`;
      grid.appendChild(weekCell);
      weekSalesTotal=0;
      weekClientTotal=0;
      weekCashTotal=0;
      weekCountedTotal=0;
      weekHasAnyCounted=false;
      weekHasAnySales=false;
      weekHasAnyCash=false;
      dayIndexInWeek=0;
    };

    // helper to build a single cell; structure is frozen
    const buildCell=(displayDay,key,dayTotals,isOtherMonth)=>{
      const cashLabel=dayTotals.cashTotal?currencyFmt.format(dayTotals.cashTotal):'';
      const soldLabel=dayTotals.soldTotal?currencyFmt.format(dayTotals.soldTotal):'';
      const hasMeta=(dayTotals.clientCount||dayTotals.serviceCount);
      const metaLabel=hasMeta?`Clients: ${integerFmt.format(dayTotals.clientCount||0)}, Services: ${integerFmt.format(dayTotals.serviceCount||0)}`:'';

      const counted=serverCounted[key]!=null?serverCounted[key]:null;
      const delta=(counted!=null?counted:0)-(dayTotals.cashTotal||0);
      const hasVariance=counted!=null&&(dayTotals.cashTotal||0);
      const varianceText=hasVariance?formatVariance(delta):'';
      const vClass=hasVariance?varianceClass(delta):'';

      if(dayTotals.soldTotal){
        weekHasAnySales=true;
        weekSalesTotal+=dayTotals.soldTotal;
      }
      if(dayTotals.cashTotal){
        weekHasAnyCash=true;
        weekCashTotal+=dayTotals.cashTotal;
      }
      if(counted!=null){
        weekHasAnyCounted=true;
        weekCountedTotal+=counted;
      }
      if(dayTotals.clientCount){
        weekClientTotal+=dayTotals.clientCount;
      }

      const c=document.createElement('div');
      c.className='cell'+(isOtherMonth?' other-month':'');
      c.innerHTML=`<div class="daynum">${displayDay}</div>
        <div class="amounts">
          ${metaLabel?`<div class="meta">${metaLabel}</div>`:''}
          <div class="sold">${soldLabel}</div>
          <div class="amt">${cashLabel}</div>
          <input class="counted-input" type="number" step="1" placeholder="Counted cash" value="${counted!=null?Math.round(counted):''}" data-date="${key}">
          <div class="count-actions">
            <button type="button" class="count-save" data-date="${key}">Save</button>
            <button type="button" class="count-clear" data-date="${key}">✕</button>
          </div>
          <div class="var-line ${vClass}">${varianceText?`Variance: ${varianceText}`:''}</div>
        </div>`;
      // stamp only appears after a successful save, not just on value
      grid.appendChild(c);
      dayIndexInWeek++;
    };

    // adjacent month helpers
    const prevMonth=m1===1?12:m1-1;
    const prevYear=m1===1?(y-1):y;
    const prevDim=daysInMonth(prevYear,prevMonth);
    const nextMonth=m1===12?1:m1+1;
    const nextYear=m1===12?(y+1):y;

    // current month rows, one week at a time, including adjacent months
    let currentDay=1;
    let nextMonthDay=1;
    while(currentDay<=dim || dayIndexInWeek!==0){
      // if starting a brand new calendar (first row, no week totals yet)
      if(weekSalesTotal===0 && weekClientTotal===0 && weekCashTotal===0 && weekCountedTotal===0 && currentDay===1){
        // leading cells from previous month
        for(let i=startDow-1;i>=0;i--){
          const displayDay=prevDim-i;
          const mm=String(prevMonth).padStart(2,'0');
          const dd=String(displayDay).padStart(2,'0');
          const key=`${prevYear}-${mm}-${dd}`;
          const dayTotals=totals[key]||{cashTotal:0,soldTotal:0,clientCount:0,serviceCount:0};
          buildCell(displayDay,key,dayTotals,true);
        }
      }

      // fill this week’s day slots with current month, then next month if needed
      while(dayIndexInWeek<7 && (currentDay<=dim || nextMonthDay===1 || currentDay>dim)){
        if(currentDay<=dim){
          const yyyy=y, mm=String(m1).padStart(2,'0'), dd=String(currentDay).padStart(2,'0');
          const key=`${yyyy}-${mm}-${dd}`;
          const dayTotals=totals[key]||{cashTotal:0,soldTotal:0,clientCount:0,serviceCount:0};
          buildCell(currentDay,key,dayTotals,false);
          currentDay++;
        } else {
          const mmNext=String(nextMonth).padStart(2,'0');
          const ddNext=String(nextMonthDay).padStart(2,'0');
          const keyNext=`${nextYear}-${mmNext}-${ddNext}`;
          const dayTotalsNext=totals[keyNext]||{cashTotal:0,soldTotal:0,clientCount:0,serviceCount:0};
          buildCell(nextMonthDay,keyNext,dayTotalsNext,true);
          nextMonthDay++;
        }
      }

      // if we couldn't place any cells (e.g., month starts on Sunday and no days left), break
      if(dayIndexInWeek===0) break;

      // add the week summary cell at fixed column 8
      appendWeekTotalCell();
    }

    // live variance and stamp update on input, without saving
    grid.querySelectorAll('.counted-input').forEach(input=>{
      input.addEventListener('input',e=>{
        const el=e.target;
        const raw=el.value.trim();
        const val=raw===''?null:Number(raw);

        const parentCell=el.closest('.cell');
        if(!parentCell)return;
        const dateKeyAttr=el.getAttribute('data-date');
        const cash=(totals[dateKeyAttr]?.cashTotal)||0;
        const countedVal=val!=null?val:0;
        const hasVarianceLocal=val!=null&&cash;
        const deltaLocal=hasVarianceLocal?(countedVal-cash):0;
        const varLine=parentCell.querySelector('.var-line');
        if(varLine){
          varLine.classList.remove('var-zero','var-under','var-over');
          if(hasVarianceLocal){
            varLine.textContent=`Variance: ${formatVariance(deltaLocal)}`;
            varLine.classList.add(varianceClass(deltaLocal));
          }else{
            varLine.textContent='';
          }
        }

        // do not toggle stamp on input alone; only on save/clear
      });
    });
  }

  // handle save / clear actions for counted cash (DB-backed)
  grid.addEventListener('click',async e=>{
    const target=e.target;
    if(target && target.classList && target.classList.contains('count-save')){
      const day=target.getAttribute('data-date');
      if(!day)return;
      const input=grid.querySelector(`.counted-input[data-date="${day}"]`);
      if(!input)return;
      const raw=input.value.trim();
      if(raw==='')return;
      const amount=Math.round(Number(raw));
      if(!Number.isFinite(amount))return;

      const headers={ 'Content-Type':'application/json' };
      const t=getToken(); if(t) headers['x-auth-token']=t;

      const resp=await fetch('/cashout/count',{
        method:'POST',
        headers,
        body:JSON.stringify({day,amount}),
      });
      if(resp.ok){
        serverCounted[day]=amount;
        // show stamp only after a successful save
        const cell=input.closest('.cell');
        if(cell){
          cell.classList.add('stamped');
          const saveBtn=cell.querySelector('.count-save');
          if(saveBtn){
            saveBtn.classList.add('saved');
            setTimeout(()=>saveBtn.classList.remove('saved'),800);
          }
        }
      }
    }

    if(target && target.classList && target.classList.contains('count-clear')){
      const day=target.getAttribute('data-date');
      if(!day)return;

      const headers={};
      const t=getToken(); if(t) headers['x-auth-token']=t;

      const resp=await fetch(`/cashout/count?day=${encodeURIComponent(day)}`,{
        method:'DELETE',
        headers,
      });
      if(resp.ok){
        serverCounted[day]=null;
        const input=grid.querySelector(`.counted-input[data-date="${day}"]`);
        if(input){
          input.value='';
        }
        const cell=input && input.closest ? input.closest('.cell') : null;
        if(cell){
          cell.classList.remove('stamped');
          const varLine=cell.querySelector('.var-line');
          if(varLine){
            varLine.textContent='';
            varLine.classList.remove('var-zero','var-under','var-over');
          }
        }
      }
    }
  });

  let Y=(new Date()).getFullYear(), M=(new Date()).getMonth()+1;
  document.getElementById('prev').onclick=()=>{ M--; if(M<1){M=12; Y--} renderCalendar(Y,M) }
  document.getElementById('next').onclick=()=>{ M++; if(M>12){M=1; Y++} renderCalendar(Y,M) }
  document.getElementById('today').onclick=()=>{ const n=new Date(); Y=n.getFullYear(); M=n.getMonth()+1; renderCalendar(Y,M) }

  (function init(){ renderWeekdayHeader(); renderCalendar(Y,M) })();
</script>
</body>
</html>
